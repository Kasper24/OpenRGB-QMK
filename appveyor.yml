image:
 - ubuntu2004
 - Visual Studio 2019
  
build_script:
- sh: sudo dpkg --add-architecture i386
- sh: sudo apt update
- sh: sudo apt install -y build-essential qt5-default libusb-1.0-0-dev libhidapi-dev pkgconf wget git
- sh: ./scripts/build-appimage.sh

- ps: $esc = "$([char]27)"
- ps: $count = 0
- ps: function _unix_tmsec_ { [int64](([datetime]::UtcNow)-(get-date "1/1/1970")).TotalSeconds }
- ps: function _fold_start_ { param( [string]$TEXT_TAG ) $t=_unix_tmsec_; $global:count += 1; Write-Host -NoNewLine "`r`n`r`nsection_start:${t}:sect_${count}`r${esc}[0K${esc}[33m${TEXT_TAG}${esc}[39m`r`n"; }
- ps: function _fold_final_ {                            $t=_unix_tmsec_;                     Write-Host -NoNewLine   "`r`n`r`nsection_end:${t}:sect_${count}`r${esc}[0K`r`n"           ; }

- ps: _fold_start_ 'configuring the msvc environment variables'
- ps: Push-Location "C:/Program Files (x86)/Microsoft Visual Studio/2019/BuildTools/VC/Auxiliary/Build"
- ps: '& cmd.exe /C "vcvarsall.bat x86 & set" | Foreach-Object { if ($_ -match "(.*?)=(.*)") { Set-Item -force -path "Env:\$($matches[1])" -value "$($matches[2])" } }'
- ps: Pop-Location
- ps: _fold_final_

- ps: _fold_start_ 'downloading precompiled versions of qtbase, qttools (for windeployqt) and jom (for a more parallel nmake)'
- ps: mkdir _qt
- ps: mkdir _qt_download
- ps: Push-Location _qt_download
- ps: curl.exe -LJ -o qt-base.7z  'https://download.qt.io/online/qtsdkrepository/windows_x86/desktop/qt5_5150/qt.qt5.5150.win32_msvc2019/5.15.0-0-202005150700qtbase-Windows-Windows_10-MSVC2019-Windows-Windows_10-X86.7z' 
- ps: curl.exe -LJ -o qt-tools.7z 'https://download.qt.io/online/qtsdkrepository/windows_x86/desktop/qt5_5150/qt.qt5.5150.win32_msvc2019/5.15.0-0-202005150700qttools-Windows-Windows_10-MSVC2019-Windows-Windows_10-X86.7z'
- ps: curl.exe -LJ -o qt-jom.zip  'https://download.qt.io/official_releases/jom/jom.zip'
- ps: _fold_final_

- ps: _fold_start_ 'extracting the downloaded qt binaries'
- ps: 7z x qt-base.7z  '-o../_qt' -y
- ps: 7z x qt-tools.7z '-o../_qt' -y
- ps: 7z x qt-jom.zip  '-o../_qt' -y
- ps: _fold_final_

- ps: _fold_start_ 'turn the qt install from enterprise to foss; remove the licensing checks'
- ps: ${qconfig-pri-folder} = '..\_qt\5.15.0\msvc2019\mkspecs\qconfig.pri'
- ps: (Get-Content ${qconfig-pri-folder}).replace('QT_EDITION = Enterprise', 'QT_EDITION = OpenSource') | Set-Content ${qconfig-pri-folder}
- ps: (Get-Content ${qconfig-pri-folder}).replace('QT_LICHECK = licheck.exe', '')                       | Set-Content ${qconfig-pri-folder}
- ps: Pop-Location
- ps: _fold_final_

- ps: _fold_start_ 'run qmake and generate the msvc nmake makefile'
- ps: mkdir _build; cd _build
- ps: ..\_qt\5.15.0\msvc2019\bin\qmake ..\OpenRGB.pro
- ps: _fold_final_

- ps: _fold_start_ 'start the actual build with jom instead of nmake; for speed'
- ps: ..\_qt\jom
- ps: _fold_final_

- ps: _fold_start_ 'run windeployqt to automatically copy the needed dll files'
- ps: ..\_qt\5.15.0\msvc2019\bin\windeployqt --no-angle --no-translations --no-opengl-sw --no-system-d3d-compiler --no-compiler-runtime --no-webkit2 .\release\
- ps: _fold_final_

- ps: _fold_start_ 'compressing the release folder so that we can upload it as artifact'
- ps: mv release 'OpenRGB Windows 32-bit'
- ps: ${datetime} = Get-Date ([datetime]::UtcNow) -Format "yyyy-MM-ddTHH-mm-ss"
- ps: ${revision} = ((git rev-parse --short HEAD) | Out-String).Trim()
- ps: ${rversion} = (((Get-Content '..\OpenRGB.pro' | Select-String -Pattern "VERSION     =") | Out-String).Trim().Split("="))[1].Trim()
- ps: 7z a -mx9 -r -y "OpenRGB_${rversion}_32_${revision}_nightly_${datetime}.7z" 'OpenRGB Windows 32-bit'
- ps: _fold_final_

artifacts:
- path: OpenRGB-x86_64.AppImage
  name: OpenRGB-x86_64

- path: _build/*.7z